# Микроконтроллер RPi

В этом документе описывается процесс запуска Klipper на RPi и использования того же RPi, что и вторичный mcu.

## Зачем использовать RPi в качестве вторичного микроконтроллера?

Часто микроконтроллеры, предназначенные для управления 3D-принтерами, имеют ограниченное и предварительно настроенное количество открытых контактов для управления основными функциями печати (терморезисторы, экструдеры, шаговые двигатели ...). Использование RPi, в котором Klipper установлен в качестве дополнительного микроконтроллера, дает возможность напрямую использовать GPIO и шины (i2c, spi) RPi внутри klipper без использования плагинов Octoprint (если они используются) или внешних программ, дающих возможность управлять всем в GCODE печати.

** Предупреждение **: Если вашей платформой является * Beaglebone* и вы правильно выполнили шаги по установке, микроконтроллер Linux уже установлен и настроен для вашей системы.

## Установите скрипт rc

Если вы хотите использовать хост в качестве дополнительного MCU, то процесс klipper_mcu должен выполняться до процесса klippy.

После установки Klipper установите скрипт. запустите:

```
cd ~/klipper/
sudo cp ./scripts/klipper-mcu.service /etc/systemd/system/
sudo systemctl enable klipper-mcu.service
```

## Создание кода микроконтроллера

Чтобы скомпилировать код микроконтроллера Klipper, начните с настройки его для "процесса Linux":

```
cd ~/klipper/
make menuconfig
```

В меню "Microcontroller Architecture" установите значение "Linux process", затем сохраните и выйдите.

Чтобы собрать и установить новый код микроконтроллера, запустите:

```
sudo service klipper stop
make flash
sudo service klipper start
```

Если klippy.log сообщает об ошибке "Отказано в разрешении" при попытке подключиться к `/tmp/klipper_host_mcu`, вам необходимо добавить своего пользователя в группу tty. Следующая команда добавит пользователя "pi" в группу tty:

```
sudo usermod -a -G tty pi
```

## Оставшаяся конфигурация

Завершите установку, настроив дополнительный микроконтроллер Klipper, следуя инструкциям в [Raspberry Pi sample config](../config/sample-raspberry-pi.cfg) и [Multi MCU sample config](../config/sample-multi-mcu.cfg).

## Необязательно: Включение SPI

Убедитесь, что драйвер Linux SPI включен, запустив `sudo raspi-config` и включив SPI в меню "Параметры взаимодействия".

## Необязательно: Включение I2C

Убедитесь, что драйвер Linux I2C включен, запустив `sudo raspi-config` и включив I2C в меню "Параметры взаимодействия". Если планируется использовать I2C для акселерометра MPU, также необходимо установить скорость передачи данных на 400000, добавив/раскомментировав `dtparam=i2c_arm=on,i2c_arm_baudrate=400000` в `/boot/config.txt ` (или `/boot/firmware/config.txt ` в некоторых дистрибутивах).

## Необязательно: Определите правильный gpiochip

На Raspberry Pi и на многих клонах контакты, выставленные на GPIO, принадлежат первому gpiochip. Поэтому их можно использовать в klipper, просто указав на них имя `gpio0..n`. Однако бывают случаи, когда открытые контакты принадлежат gpiochips, отличным от первого. Например, в случае некоторых моделей Orange Pi или при использовании расширителя портов. В этих случаях полезно использовать команды для доступа к *символьному устройству Linux GPIO* для проверки конфигурации.

Чтобы установить *Linux GPIO character device - двоичный файл* в дистрибутив на базе debian, такой как octopi, запустите:

```
sudo apt-get install gpiod
```

Чтобы проверить доступный чип, выполните:

```
gpiodetect
```

Чтобы проверить номер контакта и настройку доступности контакта:

```
gpioinfo
```

Таким образом, выбранный вывод может использоваться в конфигурации как `gpiochip<n>/gpio<o>`, где **n** - номер чипа, отображаемый командой `gpiodetect`, а **o** - номер строки, отображаемый командой 'gpioinfo`.

***Внимание:*** можно использовать только gpio, помеченный как `неиспользуемый`. Невозможно, чтобы *строка* использовалась несколькими процессами одновременно.

Например, на RPi 3B+, где Klipper использует GPIO20 для переключателя:

```
$ gpiodetect
gpiochip0 [pinctrl-bcm2835] (54 строки)
gpiochip1 [raspberrypi-exp-gpio] (8 строк)

$ gpioinfo
gpiochip0 - 54 строки:
        строка 0: безымянный неиспользуемый вход активен-высокий
        строка 1: безымянный неиспользуемый вход активен-высокий
        строка 2: безымянный неиспользуемый вход активен-высокий
        строка 3: безымянный неиспользуемый вход активен-высокий
        строка 4: безымянный неиспользуемый вход активен-высокий
        строка 5: безымянный неиспользуемый вход активен-высокий
        строка 6: безымянный неиспользуемый вход активен-высокий
        строка 7: безымянный неиспользуемый вход активен-высокий
        строка 8: безымянный неиспользуемый вход активен-высокий
        строка 9: безымянный неиспользуемый вход активен-высокий
        строка 10: безымянный неиспользуемый вход активен-высокий
        строка 11: безымянный неиспользуемый вход активен-высокий
        строка 12: безымянный неиспользуемый вход активен-высокий
        строка 13: безымянный неиспользуемый вход активен-высокий
        строка 14: безымянный неиспользуемый вход активен-высокий
        строка 15: безымянный неиспользуемый вход активен-высокий
        строка 16: безымянный неиспользуемый вход активен-высокий
        строка 17: безымянный неиспользуемый вход активен-высокий
        строка 18: безымянный неиспользуемый вход активен-высокий
        строка 19: безымянный неиспользуемый вход активен-высокий
        строка 20: неназванный выходной сигнал "klipper" активен-высокий [используется]
        строка 21: безымянный неиспользуемый вход активен-высокий
        строка 22: безымянный неиспользуемый вход активен-высокий
        строка 23: безымянный неиспользуемый вход активен-высокий
        строка 24: безымянный неиспользуемый вход активен-высокий
        строка 25: безымянный неиспользуемый вход активен-высокий
        строка 26: безымянный неиспользуемый вход активен-высокий
        строка 27: безымянный неиспользуемый вход активен-высокий
        строка 28: безымянный неиспользуемый вход активен-высокий
        строка 29: неназванный выходной сигнал "led0" активен-высокий [используется]
        строка 30: безымянный неиспользуемый вход активен-высокий
        строка 31: безымянный неиспользуемый вход активен-высокий
        строка 32: безымянный неиспользуемый вход активен-высокий
        строка 33: безымянный неиспользуемый вход активен-высокий
        строка 34: безымянный неиспользуемый вход активен-высокий
        строка 35: безымянный неиспользуемый вход активен-высокий
        строка 36: безымянный неиспользуемый вход активен-высокий
        строка 37: безымянный неиспользуемый вход активен-высокий
        строка 38: безымянный неиспользуемый вход активен-высокий
        строка 39: безымянный неиспользуемый вход активен-высокий
        строка 40: безымянный неиспользуемый вход активен-высокий
        строка 41: безымянный неиспользуемый вход активен-высокий
        строка 42: безымянный неиспользуемый вход активен-высокий
        строка 43: безымянный неиспользуемый вход активен-высокий
        строка 44: безымянный неиспользуемый вход активен-высокий
        строка 45: безымянный неиспользуемый вход активен-высокий
        строка 46: безымянный неиспользуемый вход активен-высокий
        строка 47: безымянный неиспользуемый вход активен-высокий
        строка 48: безымянный неиспользуемый вход активен-высокий
        строка 49: безымянный неиспользуемый вход активен-высокий
        строка 50: безымянный неиспользуемый вход активен-высокий
        строка 51: безымянный неиспользуемый вход активен-высокий
        строка 52: безымянный неиспользуемый вход активен-высокий
        строка 53: безымянный неиспользуемый вход активен-высокий
gpiochip1 - 8 строк:
        строка 0: безымянный неиспользуемый вход активен-высокий
        строка 1: безымянный неиспользуемый вход активен-высокий
        строка 2: неназванный выходной сигнал "led1" активен-низкий [используется]
        строка 3: безымянный неиспользуемый вход активен-высокий
        строка 4: безымянный неиспользуемый вход активен-высокий
        строка 5: безымянный неиспользуемый вход активен-высокий
        строка 6: безымянный неиспользуемый вход активен-высокий
        строка 7: безымянный неиспользуемый вход активен-высокий
```

## Дополнительно: Аппаратный ШИМ

Raspberry Pi имеет два ШИМ-канала (PWM0 и PWM1), которые отображаются в заголовке или, если нет, могут быть перенаправлены на существующие контакты gpio. Демон Linux mc использует интерфейс sysfs микросхемы pwm для управления аппаратными устройствами pwm на хостах Linux. Интерфейс pwm sysfs по умолчанию не доступен на Raspberry и может быть активирован добавлением строки в `/boot/config.txt `:

```
# # Включить интерфейс sysfs микросхемы pwm
dtoverlay=pwm,вывод=12,функция=4
```

В этом примере включается только PWM0 и перенаправляется в gpio12. Если необходимо включить оба ШИМ-канала, вы можете использовать `pwm-2chan`.

Наложение не отображает строку pwm в sysfs при загрузке и должно быть экспортировано путем повторной установки номера канала pwm в `/sys/class/pwm/pwmchip0/export`:

```
echo 0 > /sys/class/pwm/pwmchip0/экспорт
```

Это создаст устройство `/sys/class/pwm/pwmchip0/pwm0` в файловой системе. Самый простой способ сделать это - добавить это в "/etc/rc.local" перед строкой "exit 0".

Теперь, когда sysfs установлена, вы можете использовать любой из каналов pwm, добавив следующий фрагмент конфигурации в свой файл `printer.cfg`:

```
[[индикатор корпуса output_pin]
вывод: хост:pwmchip0/pwm0
pwm: True
hardware_pwm: True
cycle_time: 0.000001
```

Это добавит аппаратное управление шим к gpio12 на Pi (поскольку наложение было настроено для маршрутизации pwm0 на вывод =12).

PWM0 может быть направлен в gpio12 и gpio18, PWM1 может быть направлен в gpio13 и gpio19:

| PWM | вывод gpio | Функция |
| --- | --- | --- |
| 0 | 12 | 4 |
| 0 | 18 | 2 |
| 1 | 13 | 4 |
| 1 | 19 | 2 |
