# Протокол CANBUS

В этом документе описывается протокол, используемый Klipper для обмена данными по [CAN-шине](https://en.wikipedia.org/wiki/CAN_bus). Информацию о настройке Klipper на работу с шиной CAN см. в разделе <CANBUS.md>.

## Идентификатор микроконтроллера

Klipper использует только пакеты CAN 2.0A стандартного размера, которые ограничены 8 байтами данных и 11-битным идентификатором шины CAN. Чтобы поддерживать эффективную связь, каждому микроконтроллеру во время выполнения присваивается уникальный 1-байтовый идентификатор узла шины CAN (`canbus_nodeid`) для общего трафика команд и ответов Klipper. Командные сообщения Klipper, идущие от хоста к микроконтроллеру, используют идентификатор шины CAN `canbus_nodeid * 2 + 256`, в то время как ответные сообщения Klipper от микроконтроллера к хосту используют `canbus_nodeid * 2 + 256 + 1 `.

Каждый микроконтроллер имеет присвоенный заводом уникальный идентификатор чипа, который используется при назначении идентификатора. Этот идентификатор может превышать длину одного пакета CAN, поэтому хэш-функция используется для генерации уникального 6-байтового идентификатора (`canbus_uuid`) из заводского идентификатора.

## Сообщения администратора

Для присвоения идентификатора используются сообщения администратора. Административные сообщения, передаваемые от хоста к микроконтроллеру, используют идентификатор CAN-шины `0x3f0`, а сообщения, передаваемые от микроконтроллера к хосту, - идентификатор CAN-шины `0x3f1`. Все микроконтроллеры прослушивают сообщения с идентификатором `0x3f0`; этот идентификатор можно рассматривать как "широковещательный адрес".

### CMD_QUERY_UNASSIGNED сообщение

Эта команда запрашивает все микроконтроллеры, которым еще не присвоен `canbus_nodeid`. В ответ на запрос микроконтроллеры, которым еще не присвоен `canbus_nodeid`, выдают сообщение RESP_NEED_NODEID.

Формат сообщения CMD_QUERY_UNASSIGNED: `<1-байтовый message_id = 0x00>`

### Сообщение CMD_SET_KLIPPER_NODEID

Эта команда назначает микроконтроллеру `canbus_nodeid` с заданным `canbus_uuid`.

Формат сообщения CMD_SET_KLIPPER_NODEID следующий: `<1-байтовый message_id = 0x01><6-байтовый canbus_uuid><1-байтовый canbus_nodeid>`

### RESP_NEED_NODEID сообщение

Формат сообщения RESP_NEED_NODEID следующий: `<1-байтовый message_id = 0x20><6-байтовый canbus_uuid><1-байтовый set_klipper_nodeid = 0x01>`

## Пакеты данных

Микроконтроллер, которому присвоен идентификатор узла командой CMD_SET_KLIPPER_NODEID, может отправлять и принимать пакеты данных.

Данные пакетов в сообщениях, использующих идентификатор принимаемой CAN-шины узла (`canbus_nodeid * 2 + 256`), просто добавляются в буфер, а при обнаружении полного [mcu protocol message](Protocol.md) его содержимое разбирается и обрабатывается. Данные обрабатываются как поток байтов - нет требования, чтобы начало блока сообщений Klipper совпадало с началом пакета CAN-шины.

Аналогично, ответы на сообщения протокола mcu передаются от микроконтроллера к хосту путем копирования данных сообщения в один или несколько пакетов с идентификатором передаваемого узла CAN-шины (`canbus_nodeid * 2 + 256 + 1`).
