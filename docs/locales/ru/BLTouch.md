# BL-Touch

## Подключение BL-Touch

** ПРЕДУПРЕЖДЕНИЕ ** Перед началом работы: Не прикасайтесь к штифту BL-Touch голыми пальцами, так как он довольно чувствителен к смазке для пальцев. И если вы все-таки прикоснетесь к нему, будьте очень нежны, чтобы ничего не согнуть и не толкнуть.

Подключите разъем BL-Touch "servo" к разъему `control_pin` в соответствии с документацией BL-Touch или документацией вашего MCU. Используя оригинальную проводку, желтый провод от тройки - это `control_pin`, а белый провод от пары - `sensor_pin`. Вам необходимо настроить эти контакты в соответствии с вашей проводкой. Для большинства устройств BL-Touch требуется подтягивание вывода датчика (префикс имени вывода с помощью "^"). Например:

```
[bltouch]
сенсор_пин: ^P1.24
контрольный_пин: P1.26
```

Если BL-Touch будет использоваться для исходного положения оси Z, установите `endstop_pin:probe:z_virtual_endstop` и удалите `position_endstop` в разделе конфигурации `[stepper_z]`, затем добавьте раздел конфигурации `[safe_z_home]`, чтобы поднять ось z, возвращение осей xy, перемещение к центру станины и возвращение оси z. Например:

```
[безопасный_z_home]
home_xy_position: 100, 100 # Переместите координаты в центр печатного слоя
скорость: 50
z_hop: 10 # Переместите вверх на 10 мм
z_hop_speed: 5
```

Важно, чтобы перемещение z_hop в safe_z_home было достаточно высоким, чтобы зонд ни во что не врезался, даже если контакт зонда находится в самом низком состоянии.

## Начальные проверки

Прежде чем продолжить, убедитесь, что BL-Touch установлен на правильной высоте, штифт должен быть примерно на 2 мм выше сопла в задвинутом состоянии

При включении принтера датчик BL-Touch должен выполнить самотестирование и несколько раз переместить штифт вверх и вниз. По завершении самотестирования штифт должен быть втянут, а на датчике должен гореть красный светодиод. Если возникли какие-либо ошибки, например, датчик мигает красным цветом или штырек опускается, а не поднимается, выключите принтер и проверьте подключение и конфигурацию.

Если все вышеперечисленное выглядит хорошо, пришло время проверить, правильно ли работает управляющий контакт. Сначала запустите BLTOUCH_DEBUG COMMAND=pin_down на терминале принтера. Убедитесь, что штифт опускается вниз и красный светодиод на щупе гаснет. Если нет, проверьте проводку и конфигурацию еще раз. Затем введите `BLTOUCH_DEBUG COMMAND=pin_up`, убедитесь, что штифт перемещается вверх и красный индикатор снова загорается. Если он мигает, значит, есть какая-то проблема.

Следующим шагом является подтверждение того, что контакт датчика работает правильно. Запустите `BLTOUCH_DEBUG COMMAND=pin_down`, убедитесь, что pin-код перемещается вниз, запустите `BLTOUCH_DEBUG COMMAND=touch_mode`, запустите `QUERY_PROBE` и убедитесь, что команда сообщает "probe: открыто". Затем, слегка надавливая на булавку ногтем пальца, снова запустите `QUERY_PROBE`. Проверьте, что команда сообщает "зонд: СРАБОТАЛ". Если какой-либо запрос не выдает правильного сообщения, то это обычно указывает на неправильное подключение или конфигурацию (хотя некоторые [клоны](#bl-touch-clones) могут потребовать специальной обработки). По завершении этого теста запустите `BLTOUCH_DEBUG COMMAND=pin_up` и убедитесь, что контакт перемещается вверх.

После завершения тестов контрольного штифта BL-Touch и сенсорного штифта пришло время протестировать зондирование, но с изюминкой. Вместо того чтобы позволять штифту датчика касаться печатной подложки, позвольте ему коснуться ногтя на вашем пальце. Расположите инструментальную головку далеко от станины, нажмите `G28` (или `PROBE`, если не используете probe:z_virtual_endstop), дождитесь, пока инструментальная головка начнет опускаться, и остановите движение, очень осторожно прикоснувшись ногтем к штифту. Возможно, вам придется сделать это дважды, поскольку конфигурация самонаведения по умолчанию проверяет дважды. Будьте готовы выключить принтер, если он не остановится при нажатии на контакт.

Если это удалось, выполните еще одну операцию `G28` (или `PROBE`), но на этот раз пусть она коснется стола, как и положено.

## BL-Прикосновение испортилось

Как только BL-Touch находится в несогласованном состоянии, он начинает мигать красным. Вы можете заставить его покинуть это состояние, выдав:

КОМАНДА BLTOUCH_DEBUG=сброс

Это может произойти, если его калибровка будет прервана из-за блокировки извлечения зонда.

Однако BL-Touch, возможно, больше не сможет калиброваться самостоятельно. Это происходит, если винт на его вершине находится в неправильном положении или сместился магнитопровод внутри штифта щупа. Если он переместился вверх и прилип к винту, возможно, он больше не сможет опустить штифт. При таком поведении вам необходимо открыть винт и с помощью шариковой ручки аккуратно вернуть его на место. Снова вставьте штифт в BL-Touch так, чтобы он встал в извлеченное положение. Осторожно установите винт с головкой на место. Вам нужно найти правильное положение, чтобы он мог опускать и поднимать штифт, а красный свет включался и гас. Для этого используйте команды `reset`, `pin_up` и `pin_down`.

## BL-Touch «клоны»

Многие «клонированные» устройства BL-Touch корректно работают с Klipper, используя конфигурацию по умолчанию. Однако некоторые устройства «клонирования» могут не поддерживать команду `QUERY_PROBE`, а для некоторых устройств «клонирования» может потребоваться настройка `pin_up_reports_not_triggered` или `pin_up_touch_mode_reports_triggered`.

Важный! Не устанавливайте для `pin_up_reports_not_triggered` или `pin_up_touch_mode_reports_triggered` значение False, предварительно не следуя этим указаниям. Не устанавливайте ни одно из этих значений в значение False на подлинном BL-Touch. Неправильная установка этих значений в значение False может увеличить время проверки и увеличить риск повреждения принтера.

Некоторые устройства-клоны не поддерживают `Touch_mode`, и в результате команда `QUERY_PROBE` не работает. Несмотря на это, с помощью этих устройств по-прежнему возможно выполнять зондирование и возврат в исходное положение. На этих устройствах команда `QUERY_PROBE` во время [начальных тестов](#initial-tests) не будет успешной, однако последующий тест G28 (или `PROBE`) будет успешным. Эти «клонированные» устройства можно будет использовать с Klipper, если не использовать команду `QUERY_PROBE` и не включить функцию probe_with_touch_mode.

Некоторые устройства-"клоны" не могут выполнить проверку внутреннего датчика Klipper. На этих устройствах попытки входа в систему или зондирования могут привести к тому, что Klipper сообщит об ошибке "BLTouch не удалось проверить состояние датчика". Если это происходит, то вручную выполните действия, чтобы подтвердить работоспособность контакта датчика, как описано в разделе [начальные тесты](#initial-tests). Если команды `QUERY_PROBE` в этом тесте всегда дают ожидаемые результаты, а ошибки "BLTouch не удалось проверить состояние датчика" по-прежнему возникают, то может потребоваться установить `pin_up_touch_mode_reports_triggered` в значение False в конфигурационном файле Klipper.

Редкое количество старых устройств-"клонов" не могут сообщить об успешном запуске своего зонда. На этих устройствах Klipper будет сообщать об ошибке "BLTouch не удалось активировать зонд" после каждой домашней попытки или попытки зондирования. Можно протестировать эти устройства - отодвиньте голову подальше от кровати, запустите `BLTOUCH_DEBUG COMMAND=pin_down`, убедитесь, что pin-код переместился вниз, запустите `QUERY_PROBE`, убедитесь, что команда сообщает "зонд: открыт", запустите `BLTOUCH_DEBUG COMMAND=pin_up`, убедитесь, что pin-код переместился вверх, и запустите `QUERY_PROBE`. Если pin-код остается введенным, устройство не переходит в состояние ошибки, и первый запрос сообщает "probe: открыто", в то время как второй запрос сообщает "probe: ЗАПУЩЕНО", тогда это указывает на то, что для `pin_up_reports_not_triggered` должно быть установлено значение False в файле конфигурации Klipper.

## BL-Touch v3

Для некоторых устройств BL-Touch версии 3.0 и BL-Touch версии 3.1 может потребоваться настройка `probe_with_touch_mode` в файле конфигурации принтера.

Если сигнальный провод BL-Touch v3.0 подключен к контакту endstop (с конденсатором для фильтрации шума), то BL-Touch v3.0, возможно, не сможет последовательно посылать сигнал во время наведения и зондирования. Если команды `QUERY_PROBE` в разделе [начальные тесты](#initial-tests) всегда дают ожидаемые результаты, но инструментальная головка не всегда останавливается во время команд G28/PROBE, то это указывает на эту проблему. Обходной путь заключается в установке `probe_with_touch_mode: True` в конфигурационном файле.

BL-Touch v3.1 может неправильно перейти в состояние ошибки после успешной попытки проверки. Симптомами являются периодическое мигание индикатора на BL-Touch v3.1, которое длится пару секунд после успешного контакта с кроватью. Klipper должен автоматически устранить эту ошибку, и, как правило, она безвредна. Однако можно установить `probe_with_touch_mode` в конфигурационном файле, чтобы избежать этой проблемы.

Важный! Некоторые устройства "клонирования" и BL-Touch версии 2.0 (и более ранних версий) могут иметь пониженную точность, если для параметра `probe_with_touch_mode` установлено значение True. Установка этого параметра в значение True также увеличивает время, необходимое для развертывания зонда. При настройке этого значения на "клоне" или более старом устройстве BL-Touch обязательно проверьте точность датчика до и после установки этого значения (используйте команду `PROBE_ACCURACY` для проверки).

## Многозондирование без укладки

По умолчанию Klipper будет разворачивать зонд в начале каждой попытки зондирования, а затем убирать зонд после этого. Такое повторяющееся развертывание и укладка зонда может увеличить общее время выполнения последовательностей калибровки, которые включают в себя множество измерений зондом. Klipper поддерживает возможность оставлять зонд развернутым между последовательными зондами, что может сократить общее время зондирования. Этот режим включается путем настройки `stow_on_each_sample` на значение False в конфигурационном файле.

Важный! Установка значения `stow_on_each_sample` в значение False может привести к тому, что клипер будет совершать горизонтальные перемещения головки инструмента во время развертывания зонда. Обязательно убедитесь, что все операции зондирования имеют достаточный зазор по Z, прежде чем устанавливать это значение в значение False. Если зазор недостаточен, то горизонтальное перемещение может привести к зацеплению штифта за препятствие и повреждению принтера.

Важный! Рекомендуется использовать `probe_with_touch_mode`, настроенный на значение True, при использовании `stow_on_each_sample`, настроенного на значение False. Некоторые устройства "клонирования" могут не обнаруживать последующий контакт с кроватью, если не задан `probe_with_touch_mode`. На всех устройствах использование комбинации этих двух настроек упрощает сигнализацию устройства, что может повысить общую стабильность.

Обратите внимание, однако, что некоторые устройства "клонирования" и BL-Touch версии 2.0 (и более ранних версий) могут иметь пониженную точность, если для параметра `probe_with_touch_mode` установлено значение True. На этих устройствах рекомендуется проверить точность датчика до и после установки `probe_with_touch_mode` (для проверки используйте команду `PROBE_ACCURACY`).

## Калибровка смещений BL-Touch

Следуйте инструкциям в разделе [Калибровка датчика](Probe_Calibrate.md ) руководство по установке конфигурационных параметров x_offset, y_offset и z_offset.

Рекомендуется убедиться, что смещение по Z близко к 1 мм. Если нет, то вы, вероятно, захотите переместить зонд вверх или вниз, чтобы исправить это. Вы хотите, чтобы он сработал задолго до того, как сопло коснется слоя, чтобы возможная застрявшая нить накала или деформированный слой не повлияли на какие-либо действия по зондированию. Но в то же время вы хотите, чтобы втянутое положение было как можно выше сопла, чтобы оно не касалось деталей с печатью. Если положение датчика было скорректировано, повторите шаги калибровки датчика.

## Режим вывода BL-Touch


   * A BL-Touch V3.0 поддерживает установку выходного режима 5 В или с открытым стоком, full-Touch V3.1 также поддерживает это, но также может сохранять это во внутренней EEPROM. Если вашей плате контроллера требуется фиксированный высокий логический уровень 5 В для режима 5 В, вы можете установить параметр "set_output_mode" в разделе [bltouch] файла конфигурации принтера на "5 В".*** Используйте режим 5 В только в том случае, если входная линия вашей платы контроллера допускает напряжение 5 В. Вот почему по умолчанию в этих версиях BL-Touch используется режим ОТКРЫТЫЙ Сток. Вы потенциально можете повредить процессор платы контроллера ***

   Итак, следовательно: если плате контроллера требуется режим 5 В, И она допускает 5 В на своей входной сигнальной линии, И если

   - у вас есть BL-Touch Smart версии 3.0, вам нужен пользовательский параметр 'set_output_mode: 5V', чтобы обеспечить эту настройку при каждом запуске, поскольку датчик не может запомнить необходимую настройку.
   - у вас есть BL-Touch Smart версии 3.1, у вас есть выбор: использовать 'set_output_mode: 5V' или сохранить режим один раз с помощью команды 'BLTOUCH_STORE MODE=5V' вручную и НЕ использовать параметр 'set_output_mode:'.
   - у вас есть какой-то другой датчик: у некоторых датчиков есть след на печатной плате, который нужно вырезать, или перемычка, которую нужно установить, чтобы (постоянно) установить режим вывода. В этом случае полностью опустите параметр 'set_output_mode'.
Если у вас установлена версия 3.1, не автоматизируйте и не повторяйте сохранение режима вывода, чтобы избежать износа EEPROM датчика.EEPROM BLTouch рассчитан примерно на 100 000 обновлений. 100 магазинов в день - это примерно 3 года работы, прежде чем он выйдет из строя. Таким образом, сохранение режима вывода в версии 3.1 разработано поставщиком как сложная операция (заводским значением по умолчанию является режим безопасного открытого слива) и не подходит для повторного использования каким-либо слайсером, макросом или чем-либо еще, предпочтительно использовать его только при первой интеграции исследуйте электронику принтера.
