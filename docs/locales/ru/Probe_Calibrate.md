# Калибровка датчика

В этом документе описывается метод калибровки смещений X, Y и Z "автоматического датчика z" в Klipper. Это полезно для пользователей, у которых в конфигурационном файле есть секция `[probe]` или `[bltouch]`.

## Калибровка смещений X и Y зонда

Чтобы откалибровать смещение X и Y, перейдите на вкладку OctoPrint "Управление" ("Control"), запустите принтер, а затем используйте кнопки переключения OctoPrint для перемещения головки в положение, близкое к центру станины.

Положите кусок синей малярной ленты (или аналогичной) на ложе под зондом. Перейдите на вкладку OctoPrint "Терминал" (Terminal) и введите команду проверки:

```
PROBE
```

Сделайте отметку на ленте непосредственно под тем местом, где находится зонд (или используйте аналогичный метод, чтобы отметить местоположение на кровати).

Выдать команду `GET_POSITION` и записать положение инструментальной головки по оси XY, сообщенное этой командой. Например, если вы видите:

```
Recv: // toolhead: X:46.500000 Y:27.000000 Z:15.000000 E:0.000000
```

то можно записать положение зонда X, равное 46,5, и положение зонда Y, равное 27.

Зафиксировав положение зонда, подайте серию команд G1 до тех пор, пока сопло не окажется непосредственно над меткой на станине. Например, можно выдать:

```
G1 F300 X57 Y30 Z15
```

для перемещения сопла в положение по оси X, равное 57, и по оси Y, равное 30. Найдя положение непосредственно над меткой, с помощью команды `GET_POSITION` сообщите это положение. Это и есть положение сопла.

В этом случае x_offset равно `nozzle_x_position - probe_x_position`, а y_offset аналогично `nozzle_y_position - probe_y_position`. Обновите файл printer.cfg с заданными значениями, удалите ленту/марки со станины, а затем выполните команду `RESTART`, чтобы новые значения вступили в силу.

## Калибровка датчика со смещением по оси Z

Обеспечение точного смещения датчика z_offset имеет решающее значение для получения высококачественных отпечатков. Смещение z_offset - это расстояние между соплом и станиной в момент срабатывания датчика. Для получения этого значения можно использовать инструмент Klipper `PROBE_CALIBRATE` - он запускает автоматический датчик для измерения положения триггера датчика по оси Z, а затем запускает ручной датчик для получения высоты сопла по оси Z. Затем на основе этих измерений будет рассчитано смещение зонда по оси z.

Начните с наведения принтера, а затем переместите головку в положение, близкое к центру станины. Перейдите на вкладку терминала OctoPrint и выполните команду `PROBE_CALIBRATE` для запуска инструмента.

Этот инструмент выполнит автоматический зонд, затем поднимет головку, переместит сопло над точкой зондирования и запустит инструмент ручного зондирования. Если сопло не перемещается в положение над точкой автоматического зондирования, то следует `АБОРТИРОВАТЬ` инструмент ручного зондирования и выполнить калибровку смещения зонда по оси XY, описанную выше.

После запуска инструмента ручного зондирования выполните действия, описанные в разделе ["тест бумаги"](Bed_Level.md#the-paper-test)], чтобы определить фактическое расстояние между соплом и станиной в заданном месте. По завершении этих действий можно `принять` позицию и сохранить результаты в файле конфигурации с помощью:

```
SAVE_CONFIG
```

Обратите внимание, что если изменить систему перемещения принтера, положение хотэнда или расположение датчика, то это приведет к аннулированию результатов PROBE_CALIBRATE.

Если зонд имеет смещение по X или Y, а наклон станины изменен (например, путем регулировки винтов станины, выполнения DELTA_CALIBRATE, Z_TILT_ADJUST, QUAD_GANTRY_LEVEL и т.п.), то результаты PROBE_CALIBRATE окажутся недействительными. После выполнения любой из перечисленных выше корректировок необходимо повторно запустить PROBE_CALIBRATE.

Если результаты PROBE_CALIBRATE недействительны, то все предыдущие результаты [bed mesh](Bed_Mesh.md), полученные с помощью зонда, также будут недействительны - необходимо будет повторно запустить BED_MESH_CALIBRATE после повторной калибровки зонда.

## Проверка воспроизводимости

После калибровки смещений датчика по осям X, Y и Z следует убедиться в том, что датчик обеспечивает повторяемость результатов. Начните с самонаведения принтера, затем переместите головку в положение, близкое к центру станины. Перейдите на вкладку терминала OctoPrint и выполните команду `PROBE_ACCURACY`.

Эта команда запустит зонд десять раз и выдаст результаты, аналогичные приведенным ниже:

```
Recv: // Точность зонда: при X:0.000 Y:0.000 Z:10.000
Recv: // и считать 10 раз со скоростью 5 мм/с
Recv: // зонд в точках -0.003,0.005 имеет значение z=2.506948
Recv: // зонд в точке -0.003,0.005 имеет значение z=2.519448
Recv: // probe at -0.003,0.005 is z=2.519448
Recv: // probe at -0.003,0.005 is z=2.506948
Recv: // probe at -0.003,0.005 is z=2.519448
Recv: // probe at -0.003,0.005 is z=2.519448
Recv: // probe at -0.003,0.005 is z=2.506948
Recv: // probe at -0.003,0.005 is z=2.506948
Recv: // probe at -0.003,0.005 is z=2.519448
Recv: // probe at -0.003,0.005 is z=2.506948
Recv: // результаты точности зондирования: максимум 2,519448, минимум 2,506948, диапазон 0,012500, среднее 2,513198, медиана 2,513198, стандартное отклонение 0,006250
```

В идеальном случае инструмент выдает одинаковое максимальное и минимальное значение. (То есть в идеале датчик получает идентичный результат на всех десяти зондах). Однако нормальной является ситуация, когда минимальное и максимальное значения отличаются на один Z "шаг" или до 5 микрон (.005 мм). Расстояние "шага" равно `расстояние_вращения/(полные_шаги_на_вращение*микрошаги)`. Расстояние между минимальным и максимальным значением называется диапазоном. Так, в приведенном выше примере, поскольку принтер использует расстояние шага по Z, равное .0125, нормальным считается диапазон 0,012500.

Если результаты теста показывают значение диапазона, превышающее 25 микрон (.025 мм), значит, точность датчика недостаточна для типичных процедур выравнивания станины. Возможно, для повышения повторяемости измерений можно отрегулировать скорость перемещения датчика и/или высоту его старта. Команда `PROBE_ACCURACY` позволяет проводить тесты с различными параметрами для определения их влияния - более подробная информация приведена в документе [G-Codes](G-Codes.md#probe_accuracy). Если зонд в целом дает воспроизводимые результаты, но иногда имеет отклонения от нормы, то это можно учесть, используя несколько образцов для каждого зонда - подробнее об этом читайте в описании параметров конфигурации зонда `samples в документе [config reference](Config_Reference.md#probe).

Если требуется новая скорость зонда, количество образцов или другие настройки, то обновите файл printer.cfg и выполните команду `RESTART`. В этом случае целесообразно еще раз [откалибровать смещение z_offset](#calibrating-probe-z-offset). Если воспроизводимые результаты не могут быть получены, то не используйте зонд для выравнивания станины. В Klipper есть несколько инструментов для ручного зондирования, которые можно использовать вместо него - более подробную информацию см. в документе [Bed Level](Bed_Level.md).

## Проверка смещения местоположения

Некоторые датчики могут иметь системное смещение, искажающее результаты измерений в определенных точках инструментальной головки. Например, если крепление датчика немного наклоняется при перемещении вдоль оси Y, то это может привести к тому, что датчик будет выдавать смещенные результаты в различных положениях по оси Y.

Это распространенная проблема с датчиками на дельта-принтерах, однако она может возникать на всех принтерах.

Проверить смещение местоположения можно с помощью команды `PROBE_CALIBRATE`, измеряющей смещение z_зонда в различных точках X и Y. В идеале смещение z_зонда должно быть постоянной величиной при любом расположении принтера.

Для дельта-принтеров попробуйте измерить смещение z_offset в позиции около башни A, в позиции около башни B и в позиции около башни C. Для принтеров с картезианской, корексианской и аналогичными системами попробуйте измерить смещение z_ в точках, расположенных вблизи четырех углов станины.

Перед началом этого теста сначала откалибруйте смещения датчиков по осям X, Y и Z, как описано в начале данного документа. Затем установите принтер в исходное положение и перейдите к первой позиции XY. Выполните шаги, описанные в разделе [калибровка Z-смещения зонда](#calibrating-probe-z-offset), чтобы выполнить команду `PROBE_CALIBRATE`, команды `TESTZ` и `ACCEPT`, но не выполняйте команду `SAVE_CONFIG`. Обратите внимание на найденное значение z_offset. Затем перейдите к другим позициям XY, повторите эти шаги `PROBE_CALIBRATE` и запишите полученное значение z_offset.

Если разница между минимальным зарегистрированным смещением z_ и максимальным зарегистрированным смещением z_ превышает 25 микрон (.025 мм), то датчик не подходит для типичных процедур выравнивания слоя. Альтернативные варианты ручных датчиков см. в документе [Bed Level](Bed_Level.md).

## Температурная погрешность

Многие датчики имеют системное смещение при измерении различных температур. Например, при более высокой температуре зонд может постоянно срабатывать на меньшей высоте.

Для устранения этой погрешности рекомендуется запускать инструменты для выравнивания ложа при постоянной температуре. Например, либо всегда запускать инструменты, когда принтер находится при комнатной температуре, либо всегда запускать инструменты после того, как принтер достигнет постоянной температуры печати. В любом случае следует подождать несколько минут после достижения требуемой температуры, чтобы аппарат принтера постоянно находился при требуемой температуре.

Чтобы проверить наличие температурного смещения, запустите принтер при комнатной температуре, затем переведите принтер в исходное положение, переместите головку в положение, близкое к центру станины, и выполните команду `PROBE_ACCURACY`. Заметьте результаты. Затем, не возвращая принтер в исходное положение и не отключая шаговые двигатели, нагрейте сопло и ложе принтера до температуры печати и снова выполните команду `PROBE_ACCURACY`. В идеале команда должна выдать идентичные результаты. Как указано выше, если датчик действительно имеет температурное смещение, то необходимо следить за тем, чтобы датчик всегда использовался при постоянной температуре.
