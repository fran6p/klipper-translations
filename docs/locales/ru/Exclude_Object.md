# Исключить Объекты

The `[exclude_object]` module allows Klipper to exclude objects while a print is in progress. To enable this feature include an [exclude_object config
section](Config_Reference.md#exclude_object) (also see the [command
reference](G-Codes.md#exclude-object) and [sample-macros.cfg](../config/sample-macros.cfg) file for a Marlin/RepRapFirmware compatible M486 G-Code macro.)

В отличие от других вариантов встроенного ПО для 3D-принтеров, принтер под управлением Klipper использует набор компонентов, и у пользователей есть множество вариантов на выбор. Следовательно, чтобы обеспечить согласованное взаимодействие с пользователем, модуль `[exclude_object]` установит своего рода контракт или API. Контракт охватывает содержимое файла gcode, то, как контролируется внутреннее состояние модуля и как это состояние предоставляется клиентам.

## Обзор рабочего процесса

Типичный процесс печати файла может выглядеть следующим образом:

1. Нарезка завершена, и файл выгружается на печать. Во время загрузки файл обрабатывается, и в него добавляются маркеры `[exclude_object]`. В качестве альтернативы слайсеры могут быть настроены на подготовку маркеров исключения объектов нативно или на отдельном этапе предварительной обработки.
1. Когда начнется печать, Klipper сбросит значение `[exclude_object]` [status](Status_Reference.md#exclude_object).
1. Когда Klipper обрабатывает блок `EXCLUDE_OBJECT_DEFINE`, он обновляет статус известных объектов и передает его клиентам.
1. Клиент может использовать эту информацию для представления пользовательского интерфейса пользователю, чтобы можно было отслеживать прогресс. Klipper обновит статус, включив в него текущий печатаемый объект, который клиент может использовать для отображения.
1. Если пользователь запрашивает отмену объекта, клиент отправит Klipper команду `EXCLUDE_OBJECT NAME=<name>`.
1. Когда Klipper обработает команду, он добавит объект в список исключенных объектов и обновит статус клиента.
1. Клиент получит обновленный статус от Klipper и сможет использовать эту информацию для отражения статуса объекта в пользовательском интерфейсе.
1. После завершения печати статус `[exclude_object]` будет оставаться доступным до тех пор, пока другое действие не сбросит его.

## Файл GCode

Специализированная обработка gcode, необходимая для поддержки исключения объектов, не соответствует основным целям разработки Klipper. Поэтому этот модуль требует, чтобы файл был обработан перед отправкой в Klipper на печать. Использование сценария постобработки в слайсере или использование промежуточного программного обеспечения для обработки файла при загрузке — это две возможности подготовки файла для Klipper. Эталонный сценарий постобработки доступен как в виде исполняемого файла, так и в виде библиотеки Python, см. [cancelobject-preprocessor](https://github.com/kageurufu/cancelobject-preprocessor).

### Определения объектов

Команда `EXCLUDE_OBJECT_DEFINE` используется для предоставления сводной информации о каждом объекте в файле gcode для печати. Предоставляет сводную информацию об объекте в файле. Объекты не обязательно должны быть определены, чтобы на них могли ссылаться другие команды. Основная цель этой команды — предоставить информацию пользовательскому интерфейсу без необходимости анализа всего файла gcode.

Определениям объектов присваиваются имена, чтобы пользователи могли легко выбрать объект для исключения, а также могут быть предоставлены дополнительные метаданные для графического отображения отмены. Определенные на данный момент метаданные включают в себя координаты `ЦЕНТР` X,Y и список точек `ПОЛИГОН` из точек X,Y, представляющих минимальный контур объекта. Это может быть простая ограничивающая рамка или сложная оболочка для более детальной визуализации напечатанных объектов. Особенно, когда файлы gcode состоят из нескольких частей с перекрывающимися ограничивающими областями, центральные точки становится трудно отличить визуально. `POLYGONS` должен быть json-совместимым массивом кортежей точек `[X,Y]` без пробелов. Дополнительные параметры будут сохранены в виде строк в определении объекта и предоставлены в обновлениях статуса.

`EXCLUDE_OBJECT_DEFINE NAME=калибровка_пирамиды CENTER=50,50 POLYGON=[[40,40],[50,60],[60,40]]`

All available G-Code commands are documented in the [G-Code
Reference](./G-Codes.md#excludeobject)

## Информация о статусе

The state of this module is provided to clients by the [exclude_object
status](Status_Reference.md#exclude_object).

Статус сбрасывается, когда:

- Прошивка Klipper перезапускается.
- Происходит сброс `[virtual_sdcard]`. Примечательно, что Klipper сбрасывает это значение в начале печати.
- Когда выдается команда `EXCLUDE_OBJECT_DEFINE RESET=1`.

Список определенных объектов представлен в поле статуса `exclude_object.objects`. В четко определенном файле gcode это будет сделано с помощью команд `EXCLUDE_OBJECT_DEFINE` в начале файла. Это предоставит клиентам имена и координаты объектов, чтобы пользовательский интерфейс мог при желании предоставить графическое представление объектов.

По мере выполнения печати поле статуса `exclude_object.current_object` будет обновляться по мере того, как Klipper обрабатывает команды `EXCLUDE_OBJECT_START` и `EXCLUDE_OBJECT_END`. Поле current_object будет установлено, даже если объект был исключен. Неопределенные объекты, помеченные EXCLUDE_OBJECT_START, будут добавлены к известным объектам для помощи в подсказках пользовательского интерфейса без каких-либо дополнительных метаданных.

При выполнении команды`EXCLUDE_OBJECT` список исключенных объектов предоставляется в массиве `exclude_object.excluded_objects`. Поскольку Klipper заранее обрабатывает предстоящий gcode, между выдачей команды и обновлением статуса может возникнуть задержка.
